import React, { Component } from 'react';
import './../styles/breathing-polygon.css';
import {recurve, stats, opts} from 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/168886/recurve.js';

class BreathingPolygon extends Component {
  componentDidMount() {
    // setup options
    const opts = {
      Easing: 'Sine.inOut', easeFunction: recurve.ease.Sine.inOut,
      Speed: 1, timeScale: 0.0001,
      Size: 80, Glow: true
    };
    // DOM caching
    const svg = document.querySelector('svg');
    const ngons = [...document.querySelectorAll('.ngon')];
    const morph = document.querySelector('.morph');
    // utils
    const ptsFromPath = d => d.substring(1,d.length-1).split('L').map(s=>{
      var pt = s.split(',').map(x=>parseFloat(x));
      return { x: pt[0], y: pt[1] }
    });
    const flashElement = el => {
      el.classList.add('active');
      setTimeout(() => { el.classList.remove('active'); }, 0);
    };
    // setup tweens
    let lastNgon = 3;
    let increasing = true;
    const tweens = ngons.map((el,idx,arr) => {
    return !idx ? null :
      (() => {
        const a = ptsFromPath(arr[idx-1].getAttribute('d'));
        a.splice(Math.floor(a.length/2), 0, { x:0, y: a[Math.floor(a.length/2)].y });
        const b = ptsFromPath(el.getAttribute('d'));
        return n => {
          if (lastNgon !== idx+2) {
            lastNgon = idx+2;
            flashElement(ngons[idx-(increasing?1:0)]);
          }
          let d = 'M';
          for (var i=0, len=a.length, ni=1-n; i<len;i++)
            d += `${ni*a[i].x+n*b[i].x},${ni*a[i].y+n*b[i].y}${i<len-1?'L':'Z'}`;
          morph.setAttribute('d',d);
        };
      })();
    });
    tweens.shift();
    // animate
    const animate = recurve.compose.weighted(tweens,tweens.map(x=>1));
    const tick = (() => {
    let progress = 0;
    let prevProgress = 0;
    return time => {
        // stats.begin();
        progress = opts.easeFunction(recurve.normalize.pingpong(time*opts.timeScale));
        if ((increasing && prevProgress > progress) || (!increasing && prevProgress < progress)) {
          increasing = !increasing;
          if (progress < 0.02) {
            flashElement(ngons[0]);
          } else if (progress > 0.98) {
            flashElement(ngons[ngons.length-1]);
          }
        }
        animate(prevProgress = progress);
        window.requestAnimationFrame(tick);
        stats.end();
      };
    })();
    // start animation
    window.requestAnimationFrame(tick);
  }

  render() {
    return (
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="-120 -120 240 240">
        <defs>
          <filter id="glow">
            <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="4"></feGaussianBlur>
            <feComposite in="blur" in2="SourceGraphic" operator="over"></feComposite>
          </filter>
        </defs>
        <g class="ngon-container" filter="url(#glow)">
          <path class="ngon" id="ngon-3" fill="transparent" d="M-12.990381056766577,31.10000000000001L-2.7554552980815444e-15,8.6L12.990381056766585,31.099999999999987Z"></path>
          <path class="ngon" id="ngon-4" fill="transparent" d="M-14.14213562373095,34.94213562373095L-14.142135623730955,6.657864376269051L14.142135623730947,6.657864376269045L14.142135623730955,34.94213562373095Z"></path>
          <path class="ngon" id="ngon-5" fill="transparent" d="M-14.694631307311825,39.22542485937369L-23.77641290737884,11.274575140626318L-4.592425496802574e-15,-6L23.776412907378838,11.274575140626311L14.694631307311834,39.22542485937368Z"></path>
          <path class="ngon" id="ngon-6" fill="transparent" d="M-14.999999999999993,43.18076211353316L-30,17.200000000000003L-15.000000000000014,-8.780762113533154L14.99999999999998,-8.780762113533171L30,17.199999999999964L15.000000000000039,43.180762113533135Z"></path>
          <path class="ngon" id="ngon-7" fill="transparent" d="M-15.185930869114532,47.43391037658467L-34.122476926363824,23.688232688471004L-27.364101886381047,-5.9221430650556695L-6.429395695523604e-15,-19.1L27.36410188638104,-5.92214306505568L34.122476926363824,23.688232688470997L15.185930869114545,47.43391037658466Z"></path>
          <path class="ngon" id="ngon-8" fill="transparent" d="M-15.307337294603588,51.55518130045147L-36.95518130045147,29.9073372946036L-36.95518130045147,-0.7073372946035867L-15.307337294603613,-22.355181300451456L15.307337294603567,-22.355181300451477L36.95518130045146,-0.7073372946036169L36.955181300451486,29.907337294603565L15.307337294603618,51.55518130045146Z"></path>
          <path class="ngon" id="ngon-9" fill="transparent" d="M-15.390906449655093,55.58616793536588L-38.97114317029974,35.8L-44.31634888554936,5.4858320049881275L-28.925442435894276,-21.171999940354006L-8.266365894244634e-15,-31.700000000000003L28.925442435894265,-21.17199994035402L44.31634888554936,5.485832004988131L38.97114317029974,35.8L15.39090644965509,55.58616793536588Z"></path>
          <path class="ngon" id="ngon-10" fill="transparent" d="M-15.450849718747367,59.55282581475768L-40.45084971874737,41.38926261462366L-50,12.000000000000007L-40.45084971874737,-17.38926261462365L-15.450849718747378,-35.552825814757675L15.450849718747362,-35.55282581475768L40.450849718747364,-17.389262614623668L50,11.99999999999999L40.45084971874738,41.38926261462365L15.450849718747387,59.55282581475768Z"></path>
          <path class="ngon" id="ngon-11" fill="transparent" d="M-15.495290626278631,63.47211354879737L-41.5662265894842,46.71734036699068L-54.440179303451295,18.527316105030682L-50.029759744498506,-12.147825715103757L-29.73524496005786,-35.56894430571498L-1.0103336092965664e-14,-44.3L29.73524496005784,-35.56894430571498L50.02975974449849,-12.147825715103796L54.44017930345131,18.527316105030618L41.56622658948426,46.71734036699061L15.495290626278733,63.472113548797324Z"></path>
          <path class="ngon" id="ngon-12" fill="transparent" d="M-15.529142706151237,67.3555495773441L-42.426406871192846,51.82640687119285L-57.955549577344094,24.92914270615126L-57.95554957734411,-6.129142706151223L-42.426406871192874,-33.026406871192826L-15.52914270615129,-48.55554957734409L15.529142706151218,-48.55554957734411L42.42640687119284,-33.02640687119286L57.9555495773441,-6.129142706151242L57.955549577344094,24.92914270615126L42.426406871192825,51.82640687119288L15.529142706151195,67.3555495773441Z"></path>
          <path class="ngon" id="ngon-13" fill="transparent" d="M-15.555518178691251,71.21121813269338L-43.10297278565167,56.75319863112158L-60.776055774551956,31.14931765776483L-64.5260768163735,0.2651157834040134L-53.493951283087675,-28.824208537525113L-30.207006182844992,-49.45464166745863L-6.967190357219483e-14,-56.900000000000006L30.20700618284487,-49.45464166745869L53.49395128308759,-28.824208537525234L64.52607681637349,0.26511578340384645L60.77605577455203,31.149317657764644L43.10297278565184,56.75319863112142L15.555518178691486,71.21121813269332Z"></path>
          <path class="ngon" id="ngon-14" fill="transparent" d="M-15.576465376942004,75.04495385272764L-43.64428613011135,61.5282037727621L-63.06782075316933,37.17186173822907L-70,6.800000000000008L-63.06782075316934,-23.57186173822906L-43.64428613011136,-47.928203772762075L-15.576465376942021,-61.44495385272765L15.576465376941997,-61.44495385272765L43.64428613011134,-47.92820377276209L63.06782075316933,-23.57186173822908L70,6.799999999999983L63.06782075316935,37.171861738229055L43.64428613011136,61.52820377276207L15.576465376942028,75.04495385272764Z"></path>
          <path class="ngon" id="ngon-15" fill="transparent" d="M-15.59337681133195,78.86107005503543L-44.08389392193548,66.17627457812105L-64.9519052838329,42.99999999999999L-74.58914215262051,13.339634745073994L-71.32923872213651,-17.67627457812108L-55.735861910804545,-44.684795476914395L-30.50524823068501,-63.015909323195075L-1.3777276490407723e-14,-69.5L30.505248230684984,-63.015909323195075L55.73586191080452,-44.68479547691441L71.3292387221365,-17.676274578121138L74.58914215262051,13.339634745073901L64.95190528383296,42.999999999999886L44.08389392193561,66.17627457812097L15.593376811332124,78.86107005503538Z"></path>
          <path class="ngon" id="ngon-16" fill="transparent" d="M-15.607225761290255,82.66282243225844L-44.44561864156816,70.71756898420362L-66.5175689842036,48.645618641568205L-78.46282243225843,19.807225761290287L-78.46282243225845,-11.407225761290235L-66.51756898420363,-40.24561864156816L-44.445618641568174,-62.31756898420362L-15.607225761290222,-74.26282243225845L15.607225761290334,-74.26282243225842L44.44561864156826,-62.31756898420356L66.5175689842037,-40.24561864156806L78.46282243225846,-11.40722576129009L78.4628224322584,19.807225761290464L66.51756898420348,48.64561864156839L44.44561864156795,70.71756898420377L15.607225761289953,82.6628224322585Z"></path>
          <path class="ngon" id="ngon-17" fill="transparent" d="M-15.618709014408466,86.45271347313164L-44.74673384457522,75.16845653701722L-67.83146431882034,54.12394409223682L-81.75517966968961,26.161354156127096L-84.63740498507794,-4.9428105543806L-76.08887976518034,-34.98776024100568L-57.26412970995744,-59.915757963755965L-30.705541625908072,-76.3601394993702L-9.110941236363939e-14,-82.1L30.705541625907905,-76.36013949937029L57.26412970995728,-59.91575796375611L76.08887976518024,-34.98776024100587L84.63740498507792,-4.94281055438082L81.75517966968967,26.161354156126883L67.83146431882047,54.12394409223665L44.74673384457541,75.16845653701711L15.618709014408681,86.45271347313161Z"></path>
          <path class="ngon" id="ngon-18" fill="transparent" d="M-15.628335990023727,90.23269777109871L-44.99999999999998,79.54228634059947L-68.943999880708,59.450884871788546L-84.57233587073175,32.38181289931019L-90,1.6000000000000085L-84.57233587073176,-29.18181289931018L-68.94399988070803,-56.25088487178853L-45.00000000000004,-76.34228634059946L-15.628335990023807,-87.03269777109871L15.628335990023617,-87.03269777109875L44.99999999999987,-76.34228634059956L68.9439998807079,-56.250884871788685L84.57233587073168,-29.1818128993104L90,1.599999999999735L84.57233587073186,32.38181289930991L68.94399988070825,59.450884871788276L45.00000000000032,79.54228634059929L15.628335990024134,90.23269777109864Z"></path>
          <path class="ngon" id="ngon-19" fill="transparent" d="M-15.636486076669714,94.00432382325863L-45.21500233852199,83.85000636461646L-69.89377151394751,64.6417493044454L-86.99846603223047,38.4610653420321L-94.67552683563363,8.145037819871565L-92.09302526423639,-23.02112127837593L-79.53081543494021,-51.66007502163056L-58.350207705518464,-74.66834839265738L-30.84644957444495,-89.5526379615603L-1.745121688784978e-14,-94.7L30.846449574444918,-89.55263796156031L58.35020770551843,-74.6683483926574L79.53081543494021,-51.66007502163056L92.09302526423639,-23.021121278375926L94.67552683563363,8.145037819871572L86.99846603223045,38.4610653420321L69.8937715139475,64.6417493044454L45.21500233852198,83.85000636461648L15.636486076669708,94.00432382325863Z"></path>
        </g>
        <path class="morph" fill="transparent" stroke="#ffffff" d="M-12,25L12,25Z"></path>
      </svg>
    );
  };
}

export default BreathingPolygon;